# minikube-cluster
Deploy minikube using terraform


## About
This project shows a simple example of running a minikube cluster localy using terraform. Note some of the configuration may need to be adjusted for your use case.

## Warning
This is an example project and not production ready. Certain configurations like argocd is running as TLS disabled.

## Dependencies

* Uses docker for the VM - could use podman in the future.
* Need to have minikube and kubectl installed.
* Assumes minikube is running ```minikube start```
* Assumes this alias is setup ```kubectl='minikube -p minikube kubectl --'```
* Assumes docker desktop is running.

## To Run
You only need to run the make clean command if you want to start from scratch:

### 1. Use these make commands:
```sh
make clean
```

### 2. Install all:
```sh
make all
```

If it is successfully running you should see the minikube start/delete command. This was added to fix an error about minikube not running. Terraform init and plan to setup terraform. Then some terraform output to apply the tf files. Note the terraform apply might fail. 

```sh
minikube start --cpus 8 --memory 16384 --kubernetes-version v1.30.5 && \
	minikube delete
ğŸ˜„  minikube v1.34.0 on Darwin 14.6.1 (arm64)
âœ¨  Using the docker driver based on user configuration
ğŸ“Œ  Using Docker Desktop driver with root privileges
ğŸ‘  Starting "minikube" primary control-plane node in "minikube" cluster
ğŸšœ  Pulling base image v0.0.45 ...
ğŸ”¥  Creating docker container (CPUs=8, Memory=16384MB) ...
ğŸ³  Preparing Kubernetes v1.30.5 on Docker 27.2.0 ...
âŒ  Unable to load cached images: LoadCachedImages: stat /Users/Dave/.minikube/cache/images/arm64/registry.k8s.io/coredns/coredns_v1.11.1: no such file or directory
    â–ª Generating certificates and keys ...
    â–ª Booting up control plane ...
    â–ª Configuring RBAC rules ...
ğŸ”—  Configuring bridge CNI (Container Networking Interface) ...
ğŸ”  Verifying Kubernetes components...
    â–ª Using image gcr.io/k8s-minikube/storage-provisioner:v5
ğŸŒŸ  Enabled addons: storage-provisioner, default-storageclass
ğŸ„  Done! kubectl is now configured to use "minikube" cluster and "default" namespace by default
ğŸ”¥  Deleting "minikube" in docker ...
ğŸ”¥  Deleting container "minikube" ...
ğŸ”¥  Removing /Users/Dave/.minikube/machines/minikube ...
ğŸ’€  Removed all traces of the "minikube" cluster.
Running terraform-plan...

Initializing the backend...

Initializing provider plugins...
- Finding scott-the-programmer/minikube versions matching "0.4.2"...
- Finding gavinbunney/kubectl versions matching "1.14.0"...
- Finding hashicorp/kubernetes versions matching "2.33.0"...
- Finding hashicorp/helm versions matching "2.16.1"...
- Installing hashicorp/kubernetes v2.33.0...
- Installed hashicorp/kubernetes v2.33.0 (signed by HashiCorp)
- Installing hashicorp/helm v2.16.1...
- Installed hashicorp/helm v2.16.1 (signed by HashiCorp)
- Installing scott-the-programmer/minikube v0.4.2...

...
Plan: 6 to add, 0 to change, 0 to destroy.
minikube_cluster.docker: Creating...
minikube_cluster.docker: Still creating... [10s elapsed]
minikube_cluster.docker: Still creating... [20s elapsed]
minikube_cluster.docker: Still creating... [30s elapsed]
...
```


### Is you see this error
```sh
â”‚ Error: argocd/quay.io failed to create kubernetes rest client for update of resource: Get "http://localhost/api?timeout=32s": dial tcp [::1]:80: connect: connection refused
â”‚
â”‚   with kubectl_manifest.argocd-manifests[2],
â”‚   on argocd.tf line 19, in resource "kubectl_manifest" "argocd-manifests":
â”‚   19: resource "kubectl_manifest" "argocd-manifests" {
```
The you need to run ```sh make terraform-apply ```

It should re-apply the argocd manifests as it takes some time for argocd to be up and running.

## Accessing the cluster
Assuming terraform went well. To access the services run this script to port forward to localhost:
```sh
./setup_dev.sh
```
## Argocd will be created with admin user and an autogenerated secret.
```sh
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d; echo
```

| Service    | Link |
| -------- | -------- |
| ArgoCD  | [Launch](http://localhost:8080/applications)     |
| Kafka-UI | [Launch](http://localhost:8001/)    |
| Kafka-Dashboard    | [Launch](http://localhost:8002/) |
